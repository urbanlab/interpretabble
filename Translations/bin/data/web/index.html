<!DOCTYPE HTML>
<html>
<head>
    
    <!-- Required meta tags -->
    <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

   <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
       <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
       <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
       <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
       <script src="http://code.jquery.com/jquery-latest.js"></script>
   
</head>
<body>
    
    <!-- Begin page content -->
    <div role="main" class="container">
       <div class="row">
           <div class="col-md-12">
               <h1 class="mt-5">WebkitSpeechRecognition + websockets</h1>
               <p class="lead">Yup.</p>
           </div>
           <div class="col-md-4">
                <div class="col-md-12">
                     <label for="select_language">Language ( input )</label>
                    <select  id="select_language" class="form-control"></select>
                </div>
                </br>
                <div class="col-md-12">
                    <label for="translate_language">Language ( traduction )</label>
                    <select  id="translate_language" class="form-control"></select>
                </div>
            </div>
            <div class="col-md-8">
                <div class="col-md-12">
                <p id="transcripts"></p>
                </div>
            </div>
        </div>
    </div>
    
</body>
<script type="text/javascript">
    
    if ("WebSocket" in window) {
        var ws = new WebSocket("ws://localhost:9092/");
    } else {
        alert("WebSocket NOT supported by your Browser!");
    }

    ws.onmessage = function (evt) {
        
        var received_msg    = evt.data;
        var splitted        = received_msg.split("|");
        var type            = splitted[1];
        var msg             = splitted[2];
        
        var formatted = "<p style='color:red;'>"+msg+"</p>"
        if(type == "TRANS")
            updateField(formatted);
    };

    var mom         = this;
    var messages    = [];
    var errors      = [];
    var recognition = new webkitSpeechRecognition();
    recognition.lang = "fr-FR";
    recognition.continuous = true;

    recognition.onstart = function() {
       console.log("Started recognition");
    }

    recognition.onerror = function(event) {
        console.log("error");
        errors.push("Started recognition");
    }

    recognition.onend = function() {
        console.log("end ") + event;
        recognition.start();
    }

    recognition.onresult = function(event) {
        
        console.log("result" + event);
        
        if(event.results && event.results.length > 0 ) {
            
            var transcript = event.results[event.results.length-1][0].transcript;
            var uniqueID = (new Date()).getTime();
            
            var input   = langs[select_language.selectedIndex][1];
            var output  = langs[translate_language.selectedIndex][1];

            ws.send(uniqueID+"|RAW|"+transcript+"|"+input+"|"+output);
            
            // update field
            updateField(transcript);
            
        }
    }

    recognition.start();
    
    function updateField(message) {
        
        messages.push("<p>"+message+"</p>");
        var txt = "";
        for( var i = messages.length - 1; i >=0; i--) {
            txt += messages[i];
            
        }
        $("#transcripts").html(txt);
        
    }

    // set interval for weird bug
    // this will stop the recognition, onend event is shot, then recognition is back again
    // ¯\_(ツ)_/¯
    setInterval(resetVoiceRecog, 10000);
    var t = this;
    function resetVoiceRecog() {
        t.recognition.stop();
    }


    //---- language stuff
    var langs =
    [['Afrikaans',       ['af-ZA']],
     ['አማርኛ',           ['am-ET']],
     ['Azərbaycanca',    ['az-AZ']],
     ['বাংলা',            ['bn-BD', 'বাংলাদেশ'],
      ['bn-IN', 'ভারত']],
     ['Bahasa Indonesia',['id-ID']],
     ['Bahasa Melayu',   ['ms-MY']],
     ['Català',          ['ca-ES']],
     ['Čeština',         ['cs-CZ']],
     ['Dansk',           ['da-DK']],
     ['Deutsch',         ['de-DE']],
     ['English',         ['en-AU', 'Australia'],
      ['en-CA', 'Canada'],
      ['en-IN', 'India'],
      ['en-KE', 'Kenya'],
      ['en-TZ', 'Tanzania'],
      ['en-GH', 'Ghana'],
      ['en-NZ', 'New Zealand'],
      ['en-NG', 'Nigeria'],
      ['en-ZA', 'South Africa'],
      ['en-PH', 'Philippines'],
      ['en-GB', 'United Kingdom'],
      ['en-US', 'United States']],
     ['Español',         ['es-AR', 'Argentina'],
      ['es-BO', 'Bolivia'],
      ['es-CL', 'Chile'],
      ['es-CO', 'Colombia'],
      ['es-CR', 'Costa Rica'],
      ['es-EC', 'Ecuador'],
      ['es-SV', 'El Salvador'],
      ['es-ES', 'España'],
      ['es-US', 'Estados Unidos'],
      ['es-GT', 'Guatemala'],
      ['es-HN', 'Honduras'],
      ['es-MX', 'México'],
      ['es-NI', 'Nicaragua'],
      ['es-PA', 'Panamá'],
      ['es-PY', 'Paraguay'],
      ['es-PE', 'Perú'],
      ['es-PR', 'Puerto Rico'],
      ['es-DO', 'República Dominicana'],
      ['es-UY', 'Uruguay'],
      ['es-VE', 'Venezuela']],
     ['Euskara',         ['eu-ES']],
     ['Filipino',        ['fil-PH']],
     ['Français',        ['fr-FR']],
     ['Basa Jawa',       ['jv-ID']],
     ['Galego',          ['gl-ES']],
     ['ગુજરાતી',           ['gu-IN']],
     ['Hrvatski',        ['hr-HR']],
     ['IsiZulu',         ['zu-ZA']],
     ['Íslenska',        ['is-IS']],
     ['Italiano',        ['it-IT', 'Italia'],
      ['it-CH', 'Svizzera']],
     ['ಕನ್ನಡ',             ['kn-IN']],
     ['ភាសាខ្មែរ',          ['km-KH']],
     ['Latviešu',        ['lv-LV']],
     ['Lietuvių',        ['lt-LT']],
     ['മലയാളം',          ['ml-IN']],
     ['मराठी',             ['mr-IN']],
     ['Magyar',          ['hu-HU']],
     ['ລາວ',              ['lo-LA']],
     ['Nederlands',      ['nl-NL']],
     ['नेपाली भाषा',        ['ne-NP']],
     ['Norsk bokmål',    ['nb-NO']],
     ['Polski',          ['pl-PL']],
     ['Português',       ['pt-BR', 'Brasil'],
      ['pt-PT', 'Portugal']],
     ['Română',          ['ro-RO']],
     ['සිංහල',          ['si-LK']],
     ['Slovenščina',     ['sl-SI']],
     ['Basa Sunda',      ['su-ID']],
     ['Slovenčina',      ['sk-SK']],
     ['Suomi',           ['fi-FI']],
     ['Svenska',         ['sv-SE']],
     ['Kiswahili',       ['sw-TZ', 'Tanzania'],
      ['sw-KE', 'Kenya']],
     ['ქართული',       ['ka-GE']],
     ['Հայերեն',          ['hy-AM']],
     ['தமிழ்',            ['ta-IN', 'இந்தியா'],
      ['ta-SG', 'சிங்கப்பூர்'],
      ['ta-LK', 'இலங்கை'],
      ['ta-MY', 'மலேசியா']],
     ['తెలుగు',           ['te-IN']],
     ['Tiếng Việt',      ['vi-VN']],
     ['Türkçe',          ['tr-TR']],
     ['اُردُو',            ['ur-PK', 'پاکستان'],
      ['ur-IN', 'بھارت']],
     ['Ελληνικά',         ['el-GR']],
     ['български',         ['bg-BG']],
     ['Pусский',          ['ru-RU']],
     ['Српски',           ['sr-RS']],
     ['Українська',        ['uk-UA']],
     ['한국어',            ['ko-KR']],
     ['中文',             ['cmn-Hans-CN', '普通话 (中国大陆)'],
      ['cmn-Hans-HK', '普通话 (香港)'],
      ['cmn-Hant-TW', '中文 (台灣)'],
      ['yue-Hant-HK', '粵語 (香港)']],
     ['日本語',           ['ja-JP']],
     ['हिन्दी',             ['hi-IN']],
     ['ภาษาไทย',         ['th-TH']]];
     
     for (var i = 0; i < langs.length; i++) {
         select_language.options[i] = new Option(langs[i][0], i);
     }


    for (var i = 0; i < langs.length; i++) {
        translate_language.options[i] = new Option(langs[i][0], i);
    }

    select_language.selectedIndex       = 14;
    translate_language.selectedIndex    = 10;


    $('#select_language').on('change', function() {
        // change lang and restart
        recognition.lang = langs[this.value][1];
        recognition.stop();
    })
    
    
    </script>
</html>
